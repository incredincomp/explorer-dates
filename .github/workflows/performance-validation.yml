name: Performance Validation

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  schedule:
    - cron: '0 4 * * 1' # Mondays at 04:00 UTC
  workflow_dispatch:
    inputs:
      updateBaselines:
        description: 'Update repository performance baselines after the run completes'
        required: false
        default: false
        type: boolean

jobs:
  performance-validation:
    name: CI Performance Validation
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      PERF_UPDATE_BASELINES: ${{ ((github.event_name == 'workflow_dispatch' && inputs.updateBaselines == 'true') || (github.event_name == 'push' && github.ref == 'refs/heads/main')) && '1' || '0' }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build extension bundles
        run: npm run package-bundle

      - name: Run chunk & heap regression suite
        run: npm run test:performance-regression
        env:
          EXPLORER_DATES_UPDATE_PERF_BASELINES: ${{ env.PERF_UPDATE_BASELINES }}

      - name: Run bundle & decoration baseline suite
        run: npm run test:performance-baselines
        env:
          EXPLORER_DATES_UPDATE_PERF_BASELINES: ${{ env.PERF_UPDATE_BASELINES }}

      - name: Publish performance summary
        if: always()
        shell: bash
        run: |
          SUMMARY_FILE="${GITHUB_STEP_SUMMARY:-}"
          if [ ! -f tests/artifacts/performance/latest-metrics.json ]; then
            echo "No performance summary was generated."
            exit 0
          fi
          if [ -z "$SUMMARY_FILE" ]; then
            SUMMARY_FILE="$(mktemp)"
            export GITHUB_STEP_SUMMARY="$SUMMARY_FILE"
          fi
          node - <<'EOF'
          const fs = require('fs');
          const path = 'tests/artifacts/performance/latest-metrics.json';
          if (!fs.existsSync(path)) {
            console.log('Performance snapshot missing, skipping summary.');
            process.exit(0);
          }
          const data = JSON.parse(fs.readFileSync(path, 'utf8'));
          const lines = [];
          lines.push('| Metric | Value | Baseline | Status | Notes |');
          lines.push('| --- | --- | --- | --- | --- |');
          for (const metric of data.metrics || []) {
            const value = metric.value !== undefined ? `${metric.value}${metric.unit || ''}` : '—';
            const baseline = metric.baseline !== undefined ? `${metric.baseline}${metric.unit || ''}` : '—';
            const status = metric.status || 'n/a';
            const notes = metric.message || '';
            lines.push(`| ${metric.label} | ${value} | ${baseline} | ${status} | ${notes} |`);
          }
          fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, `${lines.join('\n')}\n`);
          EOF

      - name: Upload performance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-metrics
          path: |
            tests/artifacts/performance/latest-metrics.json
            tests/artifacts/performance/baseline-trend.json
          if-no-files-found: warn
          retention-days: 45
