var f=(a,e)=>()=>(e||a((e={exports:{}}).exports,e),e.exports);var d=f((exports,module)=>{var vscode=require("vscode"),isWebRuntime=process.env.VSCODE_WEB==="true",inspectValue=isWebRuntime?a=>{if(typeof a=="string")return a;try{return JSON.stringify(a,null,2)}catch{return"<<unable to serialize log arg>>"}}:eval("require")("util").inspect,DEFAULT_LOG_PROFILE="default",SUPPORTED_PROFILES=new Set(["default","stress","soak"]),LOG_LEVEL_ORDER=["debug","info","warn","error"],DEFAULT_CONSOLE_LEVEL="warn",TEST_CONSOLE_LEVEL=process.env.EXPLORER_DATES_TEST_MODE==="1"?"warn":null,Logger=class{constructor(){this.e=vscode.window.createOutputChannel("Explorer Dates"),this.f=!1,this.t=null,this.d=process.env.EXPLORER_DATES_TEST_MODE==="1",this.l=(process.env.EXPLORER_DATES_LOG_PROFILE||DEFAULT_LOG_PROFILE).toLowerCase(),SUPPORTED_PROFILES.has(this.l)||(this.l=DEFAULT_LOG_PROFILE),this.h=new Map,this.m=DEFAULT_CONSOLE_LEVEL,this.b(),this.t=vscode.workspace.onDidChangeConfiguration(e=>{(e.affectsConfiguration("explorerDates.enableLogging")||e.affectsConfiguration("explorerDates.consoleLogLevel"))&&this.b()})}b(){let e=vscode.workspace.getConfiguration("explorerDates");this.f=e.get("enableLogging",!1);let t=(process.env.EXPLORER_DATES_LOG_LEVEL||"").toLowerCase(),s=(e.get("consoleLogLevel",DEFAULT_CONSOLE_LEVEL)||"").toLowerCase(),i=TEST_CONSOLE_LEVEL||t||s||DEFAULT_CONSOLE_LEVEL;this.m=LOG_LEVEL_ORDER.includes(i)?i:DEFAULT_CONSOLE_LEVEL,TEST_CONSOLE_LEVEL&&(this.f=!1)}setLogProfile(e=DEFAULT_LOG_PROFILE){let t=(e||DEFAULT_LOG_PROFILE).toLowerCase();this.l=SUPPORTED_PROFILES.has(t)?t:DEFAULT_LOG_PROFILE,this.resetThrottle()}resetThrottle(e){if(e){this.h.delete(e);return}this.h.clear()}debug(e,...t){this.f&&this.L("debug",null,e,t)}info(e,...t){this.L("info",null,e,t)}infoWithOptions(e,t,...s){this.L("info",e||null,t,s)}warn(e,...t){this.L("warn",null,e,t)}error(e,t,...s){let n=`[${new Date().toISOString()}] [ERROR] ${e}`;this.d||(this.e.appendLine(n),t instanceof Error?(this.e.appendLine(`Error: ${t.message}`),t.stack&&this.e.appendLine(`Stack: ${t.stack}`)):t&&this.e.appendLine(this.p(t)));let r=this.w(s);r.length>0&&!this.d&&r.forEach(l=>this.e.appendLine(this.p(l)));let o=[];t!=null&&o.push(t),r.length>0&&o.push(...r),this.E("error",n,o)}show(){this.e.show()}clear(){this.e.clear()}dispose(){this.e.dispose(),this.t&&(this.t.dispose(),this.t=null);let e="__explorerDatesLogger";typeof global<"u"&&global[e]===this?global[e]=null:typeof globalThis<"u"&&globalThis[e]===this?globalThis[e]=null:typeof globalThis<"u"&&globalThis.window?.[e]===this&&(globalThis.window[e]=null),loggerInstance===this&&(loggerInstance=null)}L(e,t,s,i){if(e==="debug"&&!this.f||this.R(e,t))return;let r=`[${new Date().toISOString()}] [${e.toUpperCase()}] ${s}`;this.d||this.e.appendLine(r);let o=this.w(i);o.length>0&&!this.d&&o.forEach(l=>this.e.appendLine(this.p(l))),this.E(e,r,o)}w(e){return!e||e.length===0?[]:e.map(t=>{if(typeof t!="function")return t;try{return t()}catch(s){return`<<log arg threw: ${s.message}>>`}})}p(e){try{return typeof e=="string"?e:typeof e=="object"?JSON.stringify(e,null,2):inspectValue(e)}catch(t){return`<<failed to serialize log arg: ${t.message}>>`}}R(e,t){if(e!=="info"||!t||!t.throttleKey)return!1;let s=(t.profile||"stress").toLowerCase();if(!this.G(s))return!1;let i=Number(t.throttleLimit)||50,n=t.throttleKey,r=this.h.get(n)||{count:0,suppressed:0,noticeLogged:!1};if(r.count<i)return r.count+=1,this.h.set(n,r),!1;if(r.suppressed+=1,!r.noticeLogged){r.noticeLogged=!0;let o=`[${new Date().toISOString()}] [INFO] \u23F8\uFE0F Suppressing further logs for "${n}" after ${i} entries (profile=${this.l})`;this.e.appendLine(o),this.E("info",o)}return this.h.set(n,r),!0}G(e){let t=this.l||DEFAULT_LOG_PROFILE;return e==="default"?t===DEFAULT_LOG_PROFILE:t===e}y(e){let t=LOG_LEVEL_ORDER.indexOf(this.m),s=LOG_LEVEL_ORDER.indexOf(e);return t===-1||s===-1?!1:s>=t}E(e,t,s=[]){if(!this.y(e))return;(e==="warn"?console.warn:e==="error"?console.error:console.log).call(console,t,...s)}},GLOBAL_LOGGER_KEY="__explorerDatesLogger";function getLogger(){return typeof global<"u"?(global[GLOBAL_LOGGER_KEY]||(global[GLOBAL_LOGGER_KEY]=new Logger),global[GLOBAL_LOGGER_KEY]):typeof globalThis<"u"?(globalThis[GLOBAL_LOGGER_KEY]||(globalThis[GLOBAL_LOGGER_KEY]=new Logger),globalThis.window&&(globalThis.window[GLOBAL_LOGGER_KEY]=globalThis[GLOBAL_LOGGER_KEY]),globalThis[GLOBAL_LOGGER_KEY]):(loggerInstance||(loggerInstance=new Logger),loggerInstance)}var loggerInstance=null;module.exports={Logger,getLogger}});var p=f((m,L)=>{var h=require("vscode"),{getLogger:_}=d(),g=class{constructor(){this._logger=_(),this.s=[],this.c=!1,this.o=50,this.n=0,this.r=0,this.i=null,this.t=null,this.g=!0,this.a="normal",this.u=5,this._metrics={totalBatches:0,averageBatchTime:0,totalProcessingTime:0},this._logger.info("BatchProcessor initialized")}initialize(){let e=h.workspace.getConfiguration("explorerDates");this.o=this.S(e.get("batchSize",50)),this.g=e.get("adaptiveBatchProcessing",!0),this.i=h.window.createStatusBarItem(h.StatusBarAlignment.Left,-1e3),this.t&&this.t.dispose(),this.t=h.workspace.onDidChangeConfiguration(t=>{t.affectsConfiguration("explorerDates.batchSize")&&(this.o=this.S(h.workspace.getConfiguration("explorerDates").get("batchSize",50)),this._logger.debug(`Batch size updated to: ${this.o}`)),t.affectsConfiguration("explorerDates.adaptiveBatchProcessing")&&(this.g=h.workspace.getConfiguration("explorerDates").get("adaptiveBatchProcessing",!0),this._logger.debug(`Adaptive batch processing ${this.g?"enabled":"disabled"}`))})}queueForProcessing(e,t,s={}){let i={id:Date.now()+Math.random(),uris:Array.isArray(e)?e:[e],processor:t,priority:s.priority||"normal",background:s.background||!1,onProgress:s.onProgress,onComplete:s.onComplete,cancelSignal:s.cancellationToken||null,jobLabel:s.jobLabel||"batch",abortListener:null};if(i.cancelSignal){if(i.cancelSignal.aborted)return this._logger.debug(`Skipped queueing batch (${i.jobLabel}) - cancellation requested`),null;i.abortListener=()=>{this.cancelBatch(i.id,"aborted")},typeof i.cancelSignal.addEventListener=="function"&&i.cancelSignal.addEventListener("abort",i.abortListener,{once:!0})}return i.priority==="high"?this.s.unshift(i):this.s.push(i),this._logger.debug(`Queued batch ${i.id} with ${i.uris.length} URIs`),this.c||this.$(),i.id}async $(){if(this.c)return;this.c=!0,this.n=0,this.r=this.s.reduce((t,s)=>t+s.uris.length,0),this._logger.info(`Starting batch processing: ${this.r} items in ${this.s.length} batches`),this.T();let e=Date.now();try{for(;this.s.length>0;){let t=this.s.shift();await this.B(t),t.background||await this._(1)}}catch(t){this._logger.error("Batch processing failed",t)}finally{this.c=!1,this.D();let t=Date.now()-e;this.A(t),this._logger.info(`Batch processing completed in ${t}ms`)}}async B(e){let t=Date.now();if(e.cancelSignal?.aborted){this._logger.debug(`Batch ${e.id} (${e.jobLabel}) aborted before processing`),this.O(e,!1,"aborted");return}this._logger.debug(`Processing batch ${e.id} with ${e.uris.length} URIs`);try{let s=this.C(e.uris.length),i=this.F(e.uris,s);for(let n=0;n<i.length;n++){if(e.cancelSignal?.aborted){this._logger.debug(`Batch ${e.id} cancelled during chunk processing`);break}let r=i[n],o=[];for(let l of r){try{if(e.cancelSignal?.aborted){this._logger.debug(`Batch ${e.id} cancelled mid-item`);break}let c=await e.processor(l);o.push({uri:l,result:c,success:!0}),this.n++}catch(c){o.push({uri:l,error:c,success:!1}),this.n++,this._logger.debug(`Failed to process ${l.fsPath}`,c)}this.T(),e.onProgress&&e.onProgress({processed:this.n,total:this.r,current:l})}if(await this._(0),e.cancelSignal?.aborted){this._logger.debug(`Batch ${e.id} cancelled after chunk`);break}!e.background&&n<i.length-1&&await this._(5)}this.O(e,!0,null,Date.now()-t)}catch(s){this._logger.error(`Batch ${e.id} processing failed`,s),this.O(e,!1,s,Date.now()-t)}this._metrics.totalBatches++}async processDirectoryProgressively(e,t,s={}){let i=s.maxFiles||1e3;try{let n=new h.RelativePattern(e,"**/*"),r=await h.workspace.findFiles(n,null,i);if(r.length===0){this._logger.debug(`No files found in directory: ${e.fsPath}`);return}return this._logger.info(`Processing directory progressively: ${r.length} files in ${e.fsPath}`),this.queueForProcessing(r,t,{priority:"normal",background:!0,...s})}catch(n){throw this._logger.error("Progressive directory processing failed",n),n}}async refreshInBackground(e,t,s={}){return this.queueForProcessing(e,t,{background:!0,priority:"low",...s})}async refreshVisible(e,t,s={}){return this.queueForProcessing(e,t,{background:!1,priority:"high",...s})}F(e,t){let s=[];for(let i=0;i<e.length;i+=t)s.push(e.slice(i,i+t));return s}_(e){return new Promise(t=>setTimeout(t,e))}T(){if(!this.i)return;let e=this.r>0?Math.round(this.n/this.r*100):0;this.i.text=`$(sync~spin) Processing files... ${e}% (${this.n}/${this.r})`,this.i.tooltip="Explorer Dates is processing file decorations",this.i.show()}D(){this.i&&this.i.hide()}A(e){this._metrics.totalProcessingTime+=e,this._metrics.totalBatches>0&&(this._metrics.averageBatchTime=this._metrics.totalProcessingTime/this._metrics.totalBatches)}getMetrics(){return{...this._metrics,isProcessing:this.c,queueLength:this.s.length,currentProgress:this.r>0?this.n/this.r:0,batchSize:this.o,adaptiveBatching:this.g,workspaceScale:this.a}}cancelAll(){this.s.length=0,this.D(),this._logger.info("All batch processing cancelled")}cancelBatch(e,t="manual"){let s=this.s.findIndex(i=>i.id===e);if(s!==-1){let i=this.s.splice(s,1)[0];return this.P(i),this._logger.debug(`Cancelled batch ${e} with ${i.uris.length} URIs`),i.onComplete&&i.onComplete({processed:0,success:!1,error:new Error(`Batch cancelled (${t})`),duration:0}),!0}return!1}dispose(){this.cancelAll(),this.i&&this.i.dispose(),this.t&&(this.t.dispose(),this.t=null),this._logger.info("BatchProcessor disposed",this.getMetrics())}setWorkspaceScale(e="normal"){["normal","large","extreme"].includes(e)?this.a=e:this.a="normal",this._logger.debug(`Batch processor workspace scale set to ${this.a}`)}C(e){if(!this.g)return this.o;let t=1;this.a==="large"?t=.6:this.a==="extreme"&&(t=.35);let s=Math.max(this.u,Math.floor(this.o*t));return e>2e3?s=Math.max(this.u,Math.floor(s*.5)):e>500&&(s=Math.max(this.u,Math.floor(s*.75))),Math.max(this.u,s)}S(e){let t=Number(e)||50;return Math.min(200,Math.max(this.u,Math.round(t)))}O(e,t,s=null,i=0){this.P(e),e.onComplete&&e.onComplete({processed:t?e.uris.length:0,success:t,error:s,duration:i})}P(e){if(!(!e?.cancelSignal||!e.abortListener)){if(typeof e.cancelSignal.removeEventListener=="function")try{e.cancelSignal.removeEventListener("abort",e.abortListener)}catch{}e.abortListener=null}}};L.exports={BatchProcessor:g}});var{BatchProcessor:u}=p();function E(a={}){let e=new u;return typeof e.initialize=="function"&&a.autoInitialize&&e.initialize(a.autoInitialize),e}module.exports={BatchProcessor:u,createBatchProcessor:E,default:{BatchProcessor:u,createBatchProcessor:E}};
